<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lottery Phase III | Smile</title>
    <meta name="description" content="A Platform for building Enterprise Application.">
    <link rel="shortcut icon" type="image/x-icon" href="/doc-smile/docs/icon/favicon-96x96.png">
    
    <link rel="preload" href="/doc-smile/docs/assets/css/0.styles.bddf2508.css" as="style"><link rel="preload" href="/doc-smile/docs/assets/js/app.36cc31ef.js" as="script"><link rel="preload" href="/doc-smile/docs/assets/js/32.137a5787.js" as="script"><link rel="prefetch" href="/doc-smile/docs/assets/js/25.118d3b04.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/1.63391fc4.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/2.7123220c.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/3.f19ac0cc.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/4.21859165.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/5.cb607faf.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/6.ad49ce19.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/7.ff894bf8.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/8.c3298bd1.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/9.b06641e4.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/10.53a6fb8d.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/11.37127f44.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/12.b3bd6ff0.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/13.168501e5.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/14.bf49f377.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/15.2a6a6789.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/16.ab73da4a.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/17.63afd0c9.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/18.64613603.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/19.df7df6f7.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/20.5c7dd2f1.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/21.7b5989c6.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/22.5fdda26f.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/23.336783b0.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/24.259db94c.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/26.238c784d.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/27.056d4d43.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/28.76a26084.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/29.ffbdc766.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/30.4f97ebb3.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/31.dc09e694.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/33.bfe27dc0.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/34.b8be6d99.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/35.667916e8.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/36.f8a731ba.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/37.33a2b4e2.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/38.72a5495c.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/39.cecdd1f1.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/40.a2e55a06.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/41.461e4a88.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/42.3e8ff50d.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/43.1599ab27.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/44.9da6b0ab.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/45.c086a22b.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/46.af3608f4.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/47.9235a85f.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/48.be0baf33.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/49.bec51a39.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/50.a93d4a95.js"><link rel="prefetch" href="/doc-smile/docs/assets/js/51.6d60543f.js">
    <link rel="stylesheet" href="/doc-smile/docs/assets/css/0.styles.bddf2508.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/doc-smile/docs/" class="home-link router-link-active"><img src="/doc-smile/docs/smile_logo.png" class="logo"><span class="site-name can-hide">
      Smile
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/doc-smile/docs/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/doc-smile/docs/examples/" class="nav-link router-link-active">Examples</a></div><div class="nav-item"><a href="/doc-smile/docs/cookbook/" class="nav-link">Cookbook</a></div><div class="nav-item"><a href="/doc-smile/docs/training/" class="nav-link">Training</a></div><div class="nav-item"><a href="/doc-smile/docs/ecosystem/" class="nav-link">Ecosystem</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc-smile/docs/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/doc-smile/docs/examples/" class="nav-link router-link-active">Examples</a></div><div class="nav-item"><a href="/doc-smile/docs/cookbook/" class="nav-link">Cookbook</a></div><div class="nav-item"><a href="/doc-smile/docs/training/" class="nav-link">Training</a></div><div class="nav-item"><a href="/doc-smile/docs/ecosystem/" class="nav-link">Ecosystem</a></div><!----></nav><ul class="sidebar-links"><li><a href="/doc-smile/docs/examples/lottery/" class="sidebar-link">Lottery</a></li><li><a href="/doc-smile/docs/examples/lottery/lottery-phase-one.html" class="sidebar-link">Lottery Phase I</a></li><li><a href="/doc-smile/docs/examples/lottery/lottery-phase-two.html" class="sidebar-link">Lottery Phase II</a></li><li><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html" class="active sidebar-link">Lottery Phase III</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#eventify" class="sidebar-link">Eventify</a></li><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#events-and-commands" class="sidebar-link">Events and Commands</a></li><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#command-testing" class="sidebar-link">Command Testing</a></li><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#projection" class="sidebar-link">Projection</a></li><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#review-write-db" class="sidebar-link">Review Write DB</a></li><li class="sidebar-sub-header"><a href="/doc-smile/docs/examples/lottery/lottery-phase-three.html#send-mail" class="sidebar-link">Send Mail</a></li></ul></li><li><a href="/doc-smile/docs/examples/lottery/lottery-phase-four.html" class="sidebar-link">Lottery Phase IV</a></li></ul></div><div class="page"><div class="content"><h1 id="lottery-phase-iii"><a href="#lottery-phase-iii" aria-hidden="true" class="header-anchor">#</a> Lottery Phase III</h1><h2 id="eventify"><a href="#eventify" aria-hidden="true" class="header-anchor">#</a> Eventify</h2><ul><li>Edit <code>Lottery.ksmile</code></li></ul><div class="language- extra-class"><pre class="language-text"><code>stream-module LotteryStream at com.metastay.lotterystream 
</code></pre></div><ul><li>$smile</li><li>Edit <code>LotteryStream.kstream</code> , add  lottery related events</li></ul><div class="language- extra-class"><pre class="language-text"><code>event LotteryCreated(lotteryName: String, amount: Int)
event ParticipantAdded(lotteryName: String, participantName: String)
event LotteryRan(lotteryName: String, winner: String) 
</code></pre></div><ul><li>$compile</li><li>Edit <code>LotteryStreamTestSuite.scala</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>test<span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;event&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> created <span class="token operator">=</span> LotteryCreated<span class="token punctuation">(</span><span class="token string">&quot;Loto&quot;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    LotteryStreamWriter<span class="token punctuation">.</span>appendEvent<span class="token punctuation">(</span>created<span class="token punctuation">)</span>
    <span class="token keyword">val</span> ramAdded <span class="token operator">=</span> ParticipantAdded<span class="token punctuation">(</span><span class="token string">&quot;Loto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ram&quot;</span><span class="token punctuation">)</span>
    LotteryStreamWriter<span class="token punctuation">.</span>appendEvent<span class="token punctuation">(</span>ramAdded<span class="token punctuation">)</span>
    <span class="token keyword">val</span> johnAdded <span class="token operator">=</span> ParticipantAdded<span class="token punctuation">(</span><span class="token string">&quot;Loto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;john&quot;</span><span class="token punctuation">)</span>
    LotteryStreamWriter<span class="token punctuation">.</span>appendEvent<span class="token punctuation">(</span>johnAdded<span class="token punctuation">)</span>
    <span class="token keyword">val</span> ran <span class="token operator">=</span> LotteryRan<span class="token punctuation">(</span><span class="token string">&quot;Loto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;john&quot;</span><span class="token punctuation">)</span>
    LotteryStreamWriter<span class="token punctuation">.</span>appendEvent<span class="token punctuation">(</span>ran<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 
test<span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LotteryStreamReader<span class="token punctuation">.</span>count<span class="token punctuation">.</span>println
<span class="token punctuation">}</span>
</code></pre></div><ul><li>See <code>lotterystream.conf</code> file, database and how the events are getting stored.</li></ul><h2 id="events-and-commands"><a href="#events-and-commands" aria-hidden="true" class="header-anchor">#</a> Events and Commands</h2><ul><li>Add stream dependency to Domain module in lottery.ksmile.</li></ul><div class="language- extra-class"><pre class="language-text"><code>domain-module LotteryDomain(LotteryMongo,LotteryStream) at com.metastay.lotterydomain
</code></pre></div><ul><li>add stream to command-set and raise events from commands in <code>LotteryDomain.kdomain</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>command<span class="token operator">-</span>set<span class="token punctuation">[</span>LotteryStream<span class="token punctuation">]</span> Lottery <span class="token punctuation">{</span>
    domain<span class="token operator">-</span>logic<span class="token operator">-</span>ref lottery<span class="token operator">:</span>Lottery
    command create <span class="token punctuation">{</span>
        input<span class="token punctuation">(</span>lotteryName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span> amount<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
        pre <span class="token punctuation">{</span>
            condition lotterMustNotExist <span class="token string">&quot;Lottery must not exist&quot;</span> <span class="token keyword">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>lottery<span class="token punctuation">.</span>lotteryNameExists<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        event<span class="token operator">-</span>raised<span class="token punctuation">(</span>created<span class="token operator">:</span>LotteryCreated<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    command addParticipant <span class="token punctuation">{</span>
        input<span class="token punctuation">(</span>lotteryName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span> participantName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>
        pre <span class="token punctuation">{</span>
            condition lotteryMustExists <span class="token string">&quot;Lottery must exist&quot;</span> <span class="token keyword">=&gt;</span> lottery<span class="token punctuation">.</span>lotteryNameExists<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
            condition newParticpant <span class="token keyword">=&gt;</span> <span class="token operator">!</span>lottery<span class="token punctuation">.</span>participantExist<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> input<span class="token punctuation">.</span>participantName<span class="token punctuation">)</span> 
                failing <span class="token string">&quot;participant ${input.participantName} is already add to this lottery&quot;</span>
        <span class="token punctuation">}</span>
        event<span class="token operator">-</span>raised<span class="token punctuation">(</span>added<span class="token operator">:</span>ParticipantAdded<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>

    command run <span class="token punctuation">{</span>
        input <span class="token punctuation">(</span>lotteryName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
        pre<span class="token punctuation">{</span>
            condition notYetRun <span class="token keyword">=&gt;</span> lottery<span class="token punctuation">.</span>isOpenToRun<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span> failing <span class="token string">&quot;Lottery has already run!&quot;</span>
            condition existingLotteryName <span class="token keyword">=&gt;</span> lottery<span class="token punctuation">.</span>lotteryNameExists<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span> 
                failing <span class="token string">&quot;Lottery name does not exist&quot;</span>
            condition atLeastTwoParticipants <span class="token keyword">=&gt;</span> 
                existingLotteryName <span class="token operator">-</span><span class="token operator">&gt;</span> `domainLogicRef<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>participantCount<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>` 
                failing <span class="token string">&quot;The lottery should have at least two participants&quot;</span>
        <span class="token punctuation">}</span>
        event<span class="token operator">-</span>raised<span class="token punctuation">(</span>ran<span class="token operator">:</span> LotteryRan<span class="token punctuation">)</span>
        output<span class="token punctuation">(</span>winner<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
 <span class="token punctuation">}</span>
</code></pre></div><ul><li>$smile</li><li>$compile</li><li>comment the existing code in <code>LotteryCommandSetCode</code> and fix the compilation error</li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>    <span class="token keyword">override</span> <span class="token keyword">def</span> create <span class="token operator">=</span> CreateCommand <span class="token punctuation">{</span>
      <span class="token keyword">import</span> CreateCommand<span class="token punctuation">.</span>_
      input<span class="token operator">:</span> Input <span class="token keyword">=&gt;</span>
        EventRaised<span class="token punctuation">(</span>LotteryCreated<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> input<span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> addParticipant <span class="token operator">=</span> AddParticipantCommand <span class="token punctuation">{</span>
      <span class="token keyword">import</span> AddParticipantCommand<span class="token punctuation">.</span>_
      input<span class="token operator">:</span> Input <span class="token keyword">=&gt;</span>
        EventRaised<span class="token punctuation">(</span>ParticipantAdded<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> input<span class="token punctuation">.</span>participantName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> run <span class="token operator">=</span> RunCommand <span class="token punctuation">{</span>
      <span class="token keyword">import</span> RunCommand<span class="token punctuation">.</span>_
      input<span class="token operator">:</span> Input <span class="token keyword">=&gt;</span>
        <span class="token keyword">val</span> participantCount <span class="token operator">=</span> domainLogicRef<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>participantCount<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
        <span class="token keyword">val</span> winnerIndex <span class="token operator">=</span> scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>participantCount<span class="token punctuation">)</span>
        <span class="token keyword">val</span> participantList <span class="token operator">=</span> LotteryQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span><span class="token punctuation">.</span>findOne<span class="token punctuation">.</span>get<span class="token punctuation">.</span>participantList
        <span class="token keyword">val</span> winner <span class="token operator">=</span> participantList<span class="token punctuation">(</span>winnerIndex<span class="token punctuation">)</span>

        EventRaised<span class="token punctuation">(</span>LotteryRan<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> winner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Output<span class="token punctuation">(</span>winner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>Edit <code>LotteryDomain.kdomain</code> and add the handler after domain-logic definition</li></ul><div class="language- extra-class"><pre class="language-text"><code>event-handler[LotteryStream] LotteryStream {
    LotteryCreated,ParticipantAdded,LotteryRan
}
</code></pre></div><ul><li>$compile</li><li>move the commented code from <code>LotteryCommandSetCode</code> to <code>LotteryStreamEventHandlerCode</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">def</span> handleException<span class="token punctuation">(</span>event<span class="token operator">:</span> LotteryStreamEvent<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">,</span> throwable<span class="token operator">:</span> Throwable<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  appLogger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;LotteryStreamEventHandler failed: &quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span>stackTraceString<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">def</span> handle<span class="token punctuation">(</span>event<span class="token operator">:</span> LotteryCreated<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
  LotteryWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>LotteryRow<span class="token punctuation">(</span>lotteryName <span class="token operator">=</span> event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> amount <span class="token operator">=</span> event<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> open <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">override</span> <span class="token keyword">def</span> handle<span class="token punctuation">(</span>event<span class="token operator">:</span> ParticipantAdded<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> q <span class="token operator">=</span> LotteryQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
  <span class="token keyword">val</span> u <span class="token operator">=</span> LotteryUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>participantList<span class="token punctuation">.</span>addToSet<span class="token punctuation">(</span>event<span class="token punctuation">.</span>participantName<span class="token punctuation">)</span>
  LotteryWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateOne<span class="token punctuation">(</span>q<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">def</span> handle<span class="token punctuation">(</span>event<span class="token operator">:</span> LotteryRan<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> q <span class="token operator">=</span> LotteryQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
  <span class="token keyword">val</span> u <span class="token operator">=</span> LotteryUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>winner<span class="token punctuation">.</span>set<span class="token punctuation">(</span>event<span class="token punctuation">.</span>winner<span class="token punctuation">)</span>
  LotteryWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateOne<span class="token punctuation">(</span>q<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$run</li><li>Test through url in browser http://localhost:9000/api/lottery/lottery-list</li><li>or run any tests, nothing should change</li></ul><h2 id="command-testing"><a href="#command-testing" aria-hidden="true" class="header-anchor">#</a> Command Testing</h2><ul><li>Edit <code>CreateCommandTestSuite.scala</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>test<span class="token punctuation">(</span><span class="token string">&quot;create first lottery&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ptest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LotteryWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    grab<span class="token punctuation">[</span>CreateCommandFixture<span class="token punctuation">]</span>
      <span class="token punctuation">.</span>given<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>when<span class="token punctuation">(</span>Input<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expectEventRaised<span class="token punctuation">(</span>EventRaised<span class="token punctuation">(</span>LotteryCreated<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

test<span class="token punctuation">(</span><span class="token string">&quot;create new lottery with same name&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;duplicate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ntest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LotteryWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    grab<span class="token punctuation">[</span>CreateCommandFixture<span class="token punctuation">]</span>
      <span class="token punctuation">.</span>given<span class="token punctuation">(</span>LotteryCreated<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>when<span class="token punctuation">(</span>Input<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expectPreFail<span class="token punctuation">(</span><span class="token string">&quot;lotterMustNotExist&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$test-only com.metastay.lotterydomain.commandset.lottery.CreateCommandTestSuite</li><li>Edit AddParticipantCommandTestSuite.scala</li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>test<span class="token punctuation">(</span><span class="token string">&quot;add a participant&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ptest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    grab<span class="token punctuation">[</span>AddParticipantCommandFixture<span class="token punctuation">]</span>
      <span class="token punctuation">.</span>given<span class="token punctuation">(</span>LotteryCreated<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>when<span class="token punctuation">(</span>Input<span class="token punctuation">(</span>lotteryName<span class="token operator">=</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> participantName<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expectEventRaised<span class="token punctuation">(</span>EventRaised<span class="token punctuation">(</span>ParticipantAdded<span class="token punctuation">(</span>lotteryName<span class="token operator">=</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> participantName<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

test<span class="token punctuation">(</span><span class="token string">&quot;add participant with same name&quot;</span><span class="token punctuation">,</span> Tag<span class="token punctuation">(</span><span class="token string">&quot;duplicate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ntest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    grab<span class="token punctuation">[</span>AddParticipantCommandFixture<span class="token punctuation">]</span>
      <span class="token punctuation">.</span>given<span class="token punctuation">(</span>LotteryCreated<span class="token punctuation">(</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ParticipantAdded<span class="token punctuation">(</span>lotteryName<span class="token operator">=</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> participantName<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>when<span class="token punctuation">(</span>Input<span class="token punctuation">(</span>lotteryName<span class="token operator">=</span><span class="token string">&quot;TestLottery&quot;</span><span class="token punctuation">,</span> participantName<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>expectPreFail
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$test-only com.metastay.lotterydomain.commandset.lottery.AddParticipantCommandTestSuite</li></ul><h2 id="projection"><a href="#projection" aria-hidden="true" class="header-anchor">#</a> Projection</h2><ul><li>Edit <code>Lottery.ksmile</code></li><li>Also add dependency of LotteryQuery in the Play module.</li></ul><div class="language- extra-class"><pre class="language-text"><code>mongo-module LotteryReadMongo at com.metastay.lotteryreadmongo
query-module LotteryQuery(LotteryReadMongo, LotteryStream) at com.metastay.lotteryquery
</code></pre></div><ul><li>$smile,refresh eclipse</li><li>edit <code>LotteryReadMongo.kmongo</code></li></ul><div class="language- extra-class"><pre class="language-text"><code>collection LotteryRead {
  property lotteryName:String
  property amount:Int
  property participantList:String*
  property winner:String?
  property open:Boolean
}
</code></pre></div><ul><li>edit LotterQuery.kqyuery</li></ul><div class="language- extra-class"><pre class="language-text"><code>projector [LotteryStream] Lottery {
    LotteryCreated,ParticipantAdded,LotteryRan
}
</code></pre></div><ul><li>$compile</li><li>Edit <code>LotteryProjectorCode</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">def</span> project<span class="token punctuation">(</span>event<span class="token operator">:</span> LotteryCreated<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    LotteryReadWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>LotteryReadRow<span class="token punctuation">(</span>lotteryName <span class="token operator">=</span> event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> amount <span class="token operator">=</span> event<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> open <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">def</span> project<span class="token punctuation">(</span>event<span class="token operator">:</span> ParticipantAdded<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> q <span class="token operator">=</span> LotteryReadQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
    <span class="token keyword">val</span> u <span class="token operator">=</span> LotteryReadUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>participantList<span class="token punctuation">.</span>addToSet<span class="token punctuation">(</span>event<span class="token punctuation">.</span>participantName<span class="token punctuation">)</span>
    LotteryReadWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateOne<span class="token punctuation">(</span>q<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> project<span class="token punctuation">(</span>event<span class="token operator">:</span> LotteryRan<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> q <span class="token operator">=</span> LotteryReadQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
    <span class="token keyword">val</span> u <span class="token operator">=</span> LotteryReadUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>winner<span class="token punctuation">.</span>set<span class="token punctuation">(</span>event<span class="token punctuation">.</span>winner<span class="token punctuation">)</span>
    LotteryReadWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateOne<span class="token punctuation">(</span>q<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Edit LotteryWebReaderCode</li></ul><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">def</span> lotteryList<span class="token operator">:</span>Request<span class="token punctuation">[</span>LotteryListView<span class="token punctuation">.</span>Pre<span class="token punctuation">]</span> <span class="token keyword">=&gt;</span> List<span class="token punctuation">[</span>Lottery<span class="token punctuation">]</span> <span class="token operator">=</span> LotteryListView <span class="token punctuation">{</span>
  <span class="token keyword">import</span> LotteryListView<span class="token punctuation">.</span>_
  request<span class="token operator">:</span> Request<span class="token punctuation">[</span>Input<span class="token punctuation">]</span> <span class="token keyword">=&gt;</span>
    <span class="token keyword">val</span> input <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    LotteryReadQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">.</span>map<span class="token punctuation">(</span>
      row <span class="token keyword">=&gt;</span>
        Lottery<span class="token punctuation">(</span>
          lotteryName <span class="token operator">=</span> row<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span>
          amount <span class="token operator">=</span> row<span class="token punctuation">.</span>amount<span class="token punctuation">,</span>
          participantList <span class="token operator">=</span>  row<span class="token punctuation">.</span>participantList<span class="token punctuation">,</span>
          status <span class="token operator">=</span> <span class="token keyword">if</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>open<span class="token punctuation">)</span>  <span class="token string">&quot;OPEN&quot;</span> <span class="token keyword">else</span> <span class="token string">&quot;CLOSED&quot;</span><span class="token punctuation">,</span>
          winner <span class="token operator">=</span> row<span class="token punctuation">.</span>winner
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>clean the db</li><li>$run</li><li>Test through url in browser http://localhost:9000/api/lottery/lottery-list</li></ul><h2 id="review-write-db"><a href="#review-write-db" aria-hidden="true" class="header-anchor">#</a> Review Write DB</h2><ul><li>we dont really need amount and winner  in write db, they dont involve in any of the decision making in domain.</li><li>edit <code>LotteryMongo.kmongo</code> in eclipse</li></ul><div class="language- extra-class"><pre class="language-text"><code>collection Lottery {
    property lotteryName:String
    //property amount:Int
    property participantList:String*
    //property winner:String?
    property open:Boolean
}
</code></pre></div><ul><li>$compile, fix the error</li><li>Test through curl
<ul><li>curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;lotteryName&quot;:&quot;DLoto&quot;,&quot;amount&quot;:1000}' http://localhost:9000/api/lottery/create-lottery</li><li>curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;lotteryName&quot;:&quot;DLoto&quot;,&quot;participantName&quot;:&quot;John&quot;}' http://localhost:9000/api/lottery/  add-participant</li><li>curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;lotteryName&quot;:&quot;DLoto&quot;,&quot;participantName&quot;:&quot;Jim&quot;}' http://localhost:9000/api/lottery/add-participant</li><li>curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;lotteryName&quot;:&quot;DLoto&quot;,&quot;participantName&quot;:&quot;Joe&quot;}' http://localhost:9000/api/lottery/add-participant</li><li>curl -H &quot;Content-Type: application/json&quot; -X POST -d '{&quot;lotteryName&quot;:&quot;DLoto&quot;}' http://localhost:9000/api/lottery/run</li></ul></li></ul><h2 id="send-mail"><a href="#send-mail" aria-hidden="true" class="header-anchor">#</a> Send Mail</h2><ul><li><p>Sending email to winner needs us to capture email addresses for the participants</p></li><li><p>Calls for an event update &amp; change to read database to capture the email address</p></li><li><p>Capturing email of a participant and sending  email to the winner</p></li><li><p>Edit <code>LotteryReadMongo.kmongo</code></p></li></ul><div class="language- extra-class"><pre class="language-text"><code>collection LotteryRead {
     property lotteryName:String
     property amount:Int
     reference participantList:Participant*
     property winner:String?
     property open:Boolean
}

collection Participant {
     property name:String
     property email:String
}
</code></pre></div><ul><li>participant's email needs to be added to the event</li><li>Edit <code>LotteryStream.kstream</code></li></ul><div class="language- extra-class"><pre class="language-text"><code>event ParticipantAdded(lotteryName: String, participantName: String, email:String)
</code></pre></div><ul><li>Edit LotteryDomain.kdomain, replace addParticipant command with the following:</li></ul><div class="language-scala extra-class"><pre class="language-scala"><code>command addParticipant <span class="token punctuation">{</span>
    input<span class="token punctuation">(</span>lotteryName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span> participantName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>participantEmail<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    pre <span class="token punctuation">{</span>
        condition lotteryMustExists <span class="token string">&quot;Lottery must exist&quot;</span> <span class="token keyword">=&gt;</span> lottery<span class="token punctuation">.</span>lotteryNameExists<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
        condition newParticpant <span class="token keyword">=&gt;</span> <span class="token operator">!</span>lottery<span class="token punctuation">.</span>participantExist<span class="token punctuation">(</span>input<span class="token punctuation">.</span>lotteryName<span class="token punctuation">,</span> input<span class="token punctuation">.</span>participantName<span class="token punctuation">)</span> failing <span class="token string">&quot;participant ${input.participantName} is already add to this lottery&quot;</span>
    <span class="token punctuation">}</span>
    event<span class="token operator">-</span>raised<span class="token punctuation">(</span>added<span class="token operator">:</span>ParticipantAdded<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$compile, and fix the compiler errors</li><li>Edit <code>LotteryProjectorCode</code></li></ul><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">def</span> project<span class="token punctuation">(</span>event<span class="token operator">:</span> ParticipantAdded<span class="token punctuation">,</span> context<span class="token operator">:</span> EventContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> q <span class="token operator">=</span> LotteryReadQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lotteryName<span class="token punctuation">.</span>is<span class="token punctuation">(</span>event<span class="token punctuation">.</span>lotteryName<span class="token punctuation">)</span>
    <span class="token keyword">val</span> participantId <span class="token operator">=</span> <span class="token keyword">new</span> Id<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ParticipantWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>insert<span class="token punctuation">(</span>ParticipantRow<span class="token punctuation">(</span>_id <span class="token operator">=</span> participantId<span class="token punctuation">,</span> name <span class="token operator">=</span> event<span class="token punctuation">.</span>participantName<span class="token punctuation">,</span> email <span class="token operator">=</span> event<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> u <span class="token operator">=</span> LotteryReadUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>participantList_oidList<span class="token punctuation">.</span>addToSet<span class="token punctuation">(</span>participantId<span class="token punctuation">)</span>
    LotteryReadWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateOne<span class="token punctuation">(</span>q<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre></div><ul><li>$compile, fix the error</li><li>Test through curl
<ul><li>curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'lotteryName=DLoto&amp;amount=1000' 'http://localhost:9000/api/lottery/create-lottery'</li><li>curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'lotteryName=DLoto&amp;participantName=John&amp;participantEmail=john@gmail.com' 'http://localhost:9000/api/lottery/add-participant'</li><li>curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'lotteryName=DLoto&amp;participantName=Jim&amp;participantEmail=jim@gmail.com' 'http://localhost:9000/api/lottery/add-participant'</li><li>curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'lotteryName=DLoto&amp;participantName=Joe&amp;participantEmail=joe@gmail.com' 'http://localhost:9000/api/lottery/add-participant'</li><li>curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'lotteryName=DLoto' 'http://localhost:9000/api/lottery/run'</li></ul></li></ul></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
         <a href="/doc-smile/docs/examples/lottery/lottery-phase-two.html" class="prev">
          Lottery Phase II
        </a></span><span class="next"><a href="/doc-smile/docs/examples/lottery/lottery-phase-four.html">
          Lottery Phase IV
        </a> 
      </span></p></div></div></div></div>
    <script src="/doc-smile/docs/assets/js/32.137a5787.js" defer></script><script src="/doc-smile/docs/assets/js/app.36cc31ef.js" defer></script>
  </body>
</html>
